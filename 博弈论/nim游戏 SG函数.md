# 尼姆（Nim）游戏


Nim 游戏的规则是这样的：地上有 \( n \) 堆石子，甲、乙两人交替取石子。每人每次只能从任意一堆石子里面取，至少取 1 枚，不能不取。最后没有子可取的人就输了。假如甲是先手，且已知每堆石子的数量 \( a_i \)，问是否存在先手必胜的策略。


## 结论

- 若初态为**必胜态**（\( a_1 \wedge a_2 \wedge \cdots \wedge a_n \neq 0 \)），则**先手必胜**；
- 若初态为**必败态**（\( a_1 \wedge a_2 \wedge \cdots \wedge a_n = 0 \)），则**先手必败**。



## 定理证明

### 定理1：必胜态的后继状态至少存在一个必败态

**证明**：  
设 \( a_1 \wedge \cdots \wedge a_n = s \neq 0 \)，设 \( s \) 的二进制位为 1 的最高位是第 \( k \) 位，则 \( a_1, \cdots, a_n \) 中一定有奇数个 \( a_i \) 的二进制的第 \( k \) 位为 1。  
用 \( a_i \wedge s \) 去替换 \( a_i \)，则：

\[
a_1 \wedge \cdots \wedge (a_i \wedge s) \wedge \cdots \wedge a_n = a_1 \wedge \cdots \wedge a_i \wedge s \wedge \cdots \wedge a_n = s \wedge s = 0
\]

这是一种必败态。  
同时，因为 \( a_i \wedge s < a_i \)，是合法的替换。


### 定理2：必败态的后继状态均为必胜态

**证明**：  
设 \( a_1 \wedge \cdots \wedge a_n = 0 \)，则相同位上 1 的个数为偶数。此时，无论减少哪个数，都会使得异或和 ≠ 0。  

必胜态与必败态交替出现，终态 \( (0,0,\dots,0) \) 是必败态。

终态：\( a_i = 0 \)，异或和为 0，必败态。
      \(a_i \neq 0 \)，异或和 ≠ 0，必胜态。


# 台阶型 Nim游戏

有 \(1 \sim n\) 级台阶，第 \(i\) 级台阶上摆放 \(a_i\) 个石子，每次操作可将第 \(k\) 级台阶上的石子移一些到第 \(k-1\) 级台阶上，移到第 \(0\) 级台阶（地面）的石子不能再移动。

如果一个人没有石子可以移动，他就输了，问先手是否必胜。


## 结论

若奇数台阶上的石子数异或和不为 0，即 \(a_1 \oplus a_3 \oplus a_5 \oplus \cdots \neq 0\)，则先手必胜；否则先手必败。


## 定理

### 定理1：必胜态的后继状态至少存在一个必败态

### 定理2：必败态的后继状态均为必胜态


## 证明

**情况1：** 若初态奇数台阶石子异或和不为 0（必胜态），甲先手：

1. 甲选择某个奇数台阶，将其部分石子移到下一级偶数台阶，使得所有奇数台阶石子数的异或和为 0
2. 如果乙将偶数台阶的石子移到奇数台阶，甲只需将乙移动的同等数量石子继续下移到下一级偶数台阶，保持奇数台阶异或和为 0
3. 如果乙将奇数台阶的石子移到偶数台阶，甲可以调整其他奇数台阶的石子，使得奇数台阶异或和重新为 0
4. 重复上述过程，最终甲将把第 1 级台阶的石子全部移到地面，获得胜利

**情况2：** 若初态奇数台阶石子异或和为 0（必败态），甲先手：

- 无论甲如何操作，都会破坏奇数台阶石子异或和为 0 的状态
- 乙总是可以恢复奇数台阶石子异或和为 0 的状态
- 最终乙将获得胜利


# 有向图游戏

给定一个有向无环图，图中只有一个起点，在起点上放一个棋子，两个玩家轮流沿着有向边推动棋子，每次走一步，不能走的玩家失败。

---

## mex 运算 (minimum exclusion)

\[ \text{mex}(S) \] 为不属于集合 \( S \) 中的最小非负整数，

\[ \text{mex}(S) = \min\{x\} \quad (x \in N, x \notin S) \]

**例如：**
- \[ \text{mex}(\{0,1,2\}) = 3 \]
- \[ \text{mex}(\{1,2\}) = 0 \]

---

## SG 函数

设状态（节点）\( x \) 有 \( k \) 个后继状态（子节点）\( y_1, y_2, \cdots, y_k \)，

\[ SG(x) = \text{mex}(\{SG(y_1), SG(y_2), \cdots, SG(y_k)\}) \]

---

## SG 定理

由 \( n \) 个有向图游戏组成的组合游戏，设起点分别为 \( s_1, s_2, \cdots, s_n \)，当

\[ SG(s_1) \land SG(s_2) \land \cdots \land SG(s_n) \neq 0 \]

时，先手必胜；反之，先手必败。


# SG 定理证明

## 定理陈述
由 \( n \) 个有向图游戏组成的组合游戏，设起点分别为 \( s_1, s_2, \cdots, s_n \)，当
\[ SG(s_1) \land SG(s_2) \land \cdots \land SG(s_n) \neq 0 \]
时，先手必胜；反之，先手必败。

## 证明

### 基本思路
证明思路类似于 Nim 游戏的证明，通过分析必胜态和必败态的转移关系。

---

### 定义
- 令 \( X = SG(s_1) \oplus SG(s_2) \oplus \cdots \oplus SG(s_n) \)
- 终态：所有游戏都处于无法操作的状态，此时 \( X = 0 \)

---

### 证明步骤

#### 1. 终态是必败态
当所有游戏都处于无法操作的状态时：
- 所有 \( SG(s_i) = 0 \)（根据 SG 函数定义）
- 因此 \( X = 0 \oplus 0 \oplus \cdots \oplus 0 = 0 \)
- 无法进行任何操作，当前玩家失败

#### 2. 若 \( X \neq 0 \)，存在操作使 \( X = 0 \)
设 \( X = k \neq 0 \)，则存在某个 \( SG(s_i) \) 使得 \( SG(s_i) \oplus k < SG(s_i) \)

**理由**：
- 设 \( k \) 的最高位为第 \( m \) 位
- 存在 \( SG(s_i) \) 的第 \( m \) 位为 1
- 则 \( SG(s_i) \oplus k \) 的第 \( m \) 位变为 0，且更高位不变
- 因此 \( SG(s_i) \oplus k < SG(s_i) \)

**操作**：
- 选择该游戏 \( i \)
- 将其状态从 \( s_i \) 移动到某个后继状态 \( t \)，使得 \( SG(t) = SG(s_i) \oplus k \)
- 这样的 \( t \) 一定存在，因为根据 SG 函数定义，\( SG(s_i) \) 是其后继状态 SG 值的 mex
- 这意味着 \( 0 \) 到 \( SG(s_i)-1 \) 的所有值都会出现在后继状态的 SG 值中

**结果**：
- 操作后，新的异或和为：
  \[ X' = SG(s_1) \oplus \cdots \oplus SG(t) \oplus \cdots \oplus SG(s_n) \]
  \[ = SG(s_1) \oplus \cdots \oplus (SG(s_i) \oplus k) \oplus \cdots \oplus SG(s_n) \]
  \[ = (SG(s_1) \oplus \cdots \oplus SG(s_i) \oplus \cdots \oplus SG(s_n)) \oplus k \]
  \[ = k \oplus k = 0 \]

#### 3. 若 \( X = 0 \)，任何操作都会使 \( X \neq 0 \)
假设当前 \( X = 0 \)，玩家选择游戏 \( i \) 并将其状态从 \( s_i \) 移动到 \( t \)

**分析**：
- 如果 \( SG(t) = SG(s_i) \)，则异或和不变，仍为 0
- 但根据 SG 函数定义，\( SG(s_i) \) 是其后继状态 SG 值的 mex
- 这意味着 \( SG(s_i) \) 不会出现在后继状态的 SG 值中
- 因此 \( SG(t) \neq SG(s_i) \)

**结果**：
- 操作后，新的异或和为：
  \[ X' = SG(s_1) \oplus \cdots \oplus SG(t) \oplus \cdots \oplus SG(s_n) \]
  \[ = (SG(s_1) \oplus \cdots \oplus SG(s_i) \oplus \cdots \oplus SG(s_n)) \oplus SG(s_i) \oplus SG(t) \]
  \[ = 0 \oplus SG(s_i) \oplus SG(t) \]
  \[ = SG(s_i) \oplus SG(t) \neq 0 \]

---

### 结论
- 从 \( X \neq 0 \) 的状态，玩家总可以移动到 \( X = 0 \) 的状态
- 从 \( X = 0 \) 的状态，玩家只能移动到 \( X \neq 0 \) 的状态
- 终态 \( X = 0 \) 是必败态

因此，当且仅当 \( X \neq 0 \) 时，先手必胜。

证毕。