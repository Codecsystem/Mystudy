### 组合意义天地灭 代数推导保平安
>主要记录一些好玩的小玩意
>特别感谢[cbdsopa的博客-OI中基本的组合数学公式](https://www.cnblogs.com/cbdsopa/p/16319395.html)/[oi_wiki组合数学](https://oi-wiki.org/math/combinatorics/combination/)

比较深刻的是
如果两个计数过程本质相同，那么答案相同，即使过程不同

## 插板法

插板法是用于求一类给相同元素分组的方案数的一种技巧，也可以用于求一类线性不定方程的解的组数。

### 正整数和的数目

问题一：现有 $n$ 个 **完全相同** 的元素，要求将其分为 $k$ 组，保证每组至少有一个元素，一共有多少种分法？

考虑拿 $k - 1$ 块板子插入到 $n$ 个元素两两形成的 $n - 1$ 个空里面。

因为元素是完全相同的，所以答案就是 $\dbinom{n - 1}{k - 1}$。

本质是求 $x_1+x_2+\cdots+x_k=n$ 的正整数解的组数。

### 非负整数和的数目

问题二：现有 $n$ 个 **完全相同** 的元素，要求将其分为 $k$ 组，每组可以为空，一共有多少种分法？

我们考虑创造条件转化成有限制的问题一，先借 $k$ 个元素过来，在这 $n + k$ 个元素形成的 $n + k - 1$ 个空里面插板，答案为

$$
\binom{n + k - 1}{k - 1} = \binom{n + k - 1}{n}
$$

组合意义：

开头我们借来了 $k$ 个元素，用于保证每组至少有一个元素，插完板之后再把这 $k$ 个借来的元素从 $k$ 组里面拿走。因为元素是相同的，所以转化过的情况和转化前的情况可以一一对应，答案也就是相等的。

由此可以推导出插板法的公式：$\dbinom{n + k - 1}{n}$。

本质是求 $x_1+x_2+\cdots+x_k=n$ 的非负整数解的组数（即要求 $x_i \ge 0$）。

### 不同下界整数和的数目

问题三：现有 $n$ 个 **完全相同** 的元素，要求将其分为 $k$ 组，对于第 $i$ 组，至少要分到 $a_i,\sum a_i \le n$ 个元素

本质是求 $x_1+x_2+\cdots+x_k=n$ 的解的数目，其中 $x_i \ge a_i$。

类比无限制的情况，我们借 $\sum a_i$ 个元素过来，保证第 $i$ 组至少能分到 $a_i$ 个。也就是令

$$
x_i^{\prime}=x_i-a_i
$$

得到新方程：

$$
\begin{aligned}
(x_1^{\prime}+a_1)+(x_2^{\prime}+a_2)+\cdots+(x_k^{\prime}+a_k)&=n\\
x_1^{\prime}+x_2^{\prime}+\cdots+x_k^{\prime}&=n-a_1-a_2-\cdots-a_k\\
x_1^{\prime}+x_2^{\prime}+\cdots+x_k^{\prime}&=n-\sum a_i
\end{aligned}
$$

其中

$$
x_i^{\prime}\ge 0
$$

然后问题三就转化成了问题二，直接用插板法公式得到答案为

$$
\binom{n - \sum a_i + k - 1}{n - \sum a_i}
$$

### 不相邻的排列

$1 \sim n$ 这 $n$ 个自然数中选 $k$ 个，这 $k$ 个数中任何两个数都不相邻的组合有 $\dbinom {n-k+1}{k}$ 种。

组合意义：

假设我们已经完成了选择。那么这 $n$ 个数就被分成了两类：
- 被选中的数
- 没被选中的数

我们考虑把$ n-k $没被选中的数分别排成一列,产生了 $n-k+1$ 个空,然后在这 $n-k+1$ 个空里面插入 $k$ 个板子 ,答案就是 $\dbinom {n-k+1}{k}$ 种。

构造双射：

问题等价于 我们需要从 $1, 2, \dots, n$ 中选出 $k$ 个数，设这就 $k$ 个数从小到大排序后为 $a_1, a_2, \dots, a_k$。 满足：
    $$1 \le a_1 < a_2 < \dots < a_k \le n$$
且
    $$a_{i+1} - a_i \ge 2 \quad (1 \le i < k)$$
考虑构造
    $$b_i = a_i - (i - 1)$$ 
原式变为
    $$b_i < b_{i+1}$$
$b_i$ 上界
    $$b_k = a_k - (k - 1) \le n - (k - 1) = n - k + 1$$
经过变换后，原问题等价于：
从整数集合 $\{1, 2, \dots, n-k+1\}$ 中选出 $k$ 个互不相同的整数 $b_1 < b_2 < \dots < b_k$
这个问题是简单的，请读者自己算

## 组合恒等式
### 1. 对称式
$$\binom{n}{m} = \binom{n}{n-m}$$
组合意义: 你 $n$ 中拿 $m$ 个等价于有 $n-m$ 个不拿。

### 2. 二项式定理/多项式定理

$$(x+y)^n = \sum_{i=0}^n \binom{n}{i} x^i y^{n-i}$$
组合意义：
我们把 $(x+y)^n$ 看作是有 $n$ 个 $(x+y)$ 相乘，那么得到一个 $x^a y^{n-a}$ 相当于是从 $n$ 个 $(x+y)$ 中选出 $a$ 个 $(x+y)$ 中的 $x$ 相乘，那么结果的多项式中就有一项是 $\binom{n}{a} x^a y^{n-a}$ 。所有的这种项都满足这种情况，那么公式可得。


其实不一定要求必须是两元的，多元的也是同理。
然后我们可以得到**多项式定理**：

$$(x_1 + x_2 + \dots + x_m)^n = \sum_{n_1 + n_2 + \dots + n_m = n} \binom{n}{n_1, n_2, \dots, n_m} x_1^{n_1} x_2^{n_2} \cdots x_m^{n_m}$$

证明：
同二项式定理证明，对于 $x_1^{n_1} x_2^{n_2} \cdots x_m^{n_m}$ 这一项的系数为 $\binom{n}{n_1}\binom{n-n_1}{n_2}\cdots\binom{n-n_1-n_2-\dots-n_{m-1}}{n_m}$ 。
展开发现可以抵消一些东西，于是上面的系数就等于：

$$\frac{n!}{n_1! n_2! \cdots n_m!} = \binom{n}{n_1, n_2, \dots, n_m}$$

其实这个式子就是多重集排列数

### 3. 帕斯卡定理

$$\binom{n}{k} = \binom{n-1}{k-1} + \binom{n-1}{k}$$
我们知道 $(x+y)^n$ 得到的多项式是系数满足杨辉三角的，我们知道了二项式定理的话，这个东西就是杨辉三角的递推式。

组合意义：
考虑已经选了$n-1$个数，现在要选第$n$个数，那么第$n$个数选了的话，就相当于从$n-1$个数中选$k-1$个数，第$n$个数没选的话，就相当于从$n-1$个数中选$k$个数。

### 4. 特殊的二项式定理/第一类二项式反演

$$\binom{n}{0} + \binom{n}{1} + \dots + \binom{n}{n} = 2^n \tag{1}$$

实际上是 $(1+1)^n$ ，当然也可以从组合意义上证明 ，当然这是不必要的。

$$\sum_{i=0}^n (-1)^i \binom{n}{i} = [n=0] \tag{2}$$

实际上是 $(1-1)^n$ ，我称之为第一类二项式反演。

### 5. 递推式 1

$$\binom{n}{k} = \frac{n}{k} \binom{n-1}{k-1}$$

按定义来就没了，简单提一下。

代数推导：

$$\begin{aligned}
\binom{n}{k} &= \frac{n!}{k!(n-k)!} \\
&= \frac{n!}{(k-1)!(n-k)!} \cdot \frac{n}{k} \\
&= \frac{n}{k} \binom{n-1}{k-1}
\end{aligned}$$

这个式子比较深刻
比如，要求解这个经典求和：$$S = \sum_{k=0}^{n} k \binom{n}{k}$$直接算很难，因为系数里有个 $k$。利用 $\color{red}{k \binom{n}{k} = n \binom{n-1}{k-1}}$，我们可以把 $k$ “吸”进组合数里，把常数 $n$ “吐”出来：$$\begin{aligned}
\sum_{k=1}^{n} k \binom{n}{k} &= \sum_{k=1}^{n} n \binom{n-1}{k-1} \\
&= n \sum_{k=1}^{n} \binom{n-1}{k-1} \quad (\text{令 } j = k-1) \\
&= n \sum_{j=0}^{n-1} \binom{n-1}{j} \\
&= n \cdot 2^{n-1}
\end{aligned}$$
>这个式子正是7.变下项求和式中的第一个式子。

### 6. 积式

$$\binom{n}{r} \binom{r}{k} = \binom{n}{k} \binom{n-k}{r-k}$$
定义展开左边上下分子分母同乘 $(n-k)!$ 即可证明。

代数推导：
$$\begin{aligned}
\binom{n}{r} \binom{r}{k} &= \frac{n!}{r!(n-r)!} \cdot \frac{r!}{k!(r-k)!} \\
&= \frac{n!}{k!(n-k)!} \cdot \frac{(n-k)!}{(r-k)!(n-r)!} \\
&= \binom{n}{k} \binom{n-k}{r-k}
\end{aligned}$$

### 7. 变下项求和式

$$\sum_{k=0}^n k \binom{n}{k} = n 2^{n-1} \tag{1}$$

代数推导：

$$\begin{aligned}
\sum_{k=0}^n k \binom{n}{k} &= \sum_{k=1}^n k \binom{n}{k} \\
&= \sum_{k=1}^n n \binom{n-1}{k-1} \\
&= n \sum_{i=0}^{n-1} \binom{n-1}{i} \\
&= n 2^{n-1}
\end{aligned}$$

从二项式定理的求导也可以推出
利用二项式定理：$$(1+x)^n = \sum_{k=0}^n \binom{n}{k} x^k$$两边对 $x$ 求导：$$n(1+x)^{n-1} = \sum_{k=0}^n k \binom{n}{k} x^{k-1}$$令 $x=1$，代入得：$$n(1+1)^{n-1} = \sum_{k=0}^n k \binom{n}{k} (1)^{k-1}$$$$n 2^{n-1} = \sum_{k=0}^n k \binom{n}{k}$$


$$\sum_{k=0}^n k^2 \binom{n}{k} = n(n+1) 2^{n-2} \tag{2}$$

证明和上面差不多，就不证了。


### 8. 变上项求和式

$$\sum_{l=0}^n \binom{l}{k} = \binom{n+1}{k+1} \tag{1}$$

组合意义：
指定 $n+1$ 个数的集合 $S=\{a_1, a_2, \dots, a_{n+1}\}$。
先考虑右边的组合意义，即从 $n+1$ 个数中选出 $k+1$ 个。
左边的组合意义：相当于是总共 $n+1$ 种不累加的情况的加法原理。

第一种：指定必须选择 $a_1$，然后从剩余的 $n$ 个数中选择 $k$ 个，方案数 $\binom{n}{k}$。

第二种：指定必须不选择 $a_1$ 而选择 $a_2$ ，然后从剩余的 $n-1$ 个数中选择 $k$ 个，方案数 $\binom{n-1}{k}$。

第三种：指定必须不选择 $a_1, a_2$ 而选择 $a_3$ ，然后从剩余的 $n-2$ 个数中选择 $k$ 个，方案数 $\binom{n-2}{k}$。

$$\vdots$$

第 $n+1$ 种：指定必须不选择 $a_1, a_2, \dots, a_n$ 而选择 $a_{n+1}$ ，然后从剩余的 $0$ 个数中选择 $k$ 个，方案数 $\binom{0}{k}$。

总体的组合意义 $\sum_{i=0}^n \binom{i}{k}$ 等价于从 $n+1$ 个数中选出 $k+1$ 个，那么等式左右两边组合意义相同，等式成立。

### 8.1 变上项求和式 (扩展)

$$\sum_{i=0}^n \binom{i+m}{m} = \binom{n+m+1}{m+1} \tag{2}$$

另外的一种常用的形式是上下项共变的。
证明和上面的式子是类似的。
但是我们采取代数推导：
$$S = \underbrace{\binom{m+1}{m+1}}_{\text{原}\binom{m}{m}} + \binom{m+1}{m} + \binom{m+2}{m} + \dots + \binom{n+m}{m}$$

$$S = \underbrace{\binom{m+2}{m+1} + \binom{m+2}{m}}_{\text{合并这两项}} + \dots + \binom{n+m}{m} \tag{3.pascal}$$  

一直合并 Q.E.D.

### 9. 积和式 (范德蒙德卷积)


$$\sum_{k=0}^r \binom{m}{k} \binom{n}{r-k} = \binom{m+n}{r}, \quad r \le \min\{n,m\} \tag{1}$$

组合意义：
指定集合 $A=\{a_1, a_2, \dots, a_m\}$ 和 $B=\{b_1, b_2, \dots, b_n\}$。
右边问题等价于从 $A, B$ 两个集合中选出 $r$ 个的方案数。
左边问题等价于：
对于 $k \in [0, r]$，先在 $A$ 中先取出 $k$ 个，然后在 $B$ 中选出 $r-k$ 个的总方案数。
即 $A, B$ 中总共选出 $r$ 个的方案数。
所以左右两个问题组合意义等价，等式成立。

$$\sum_{i=0}^n \binom{n}{i}^2 = \binom{2n}{n} \tag{2}$$

这是 **9.积和式** 的一种特殊情况，代入 $m=n$ 即可。


$$\sum_{k=0}^r \binom{k}{a} \binom{r-k}{b} = \binom{r+1}{a+b+1} \tag{3}$$

几何意义：
指定集合 $S=\{a_1, a_2, \dots, a_{r+1}\}$。
右边问题等价于从 $S$ 中选出 $a+b+1$ 个数。
左边问题等价于：
第 $i$ 种，指定选出 $a_i$ ，然后再在 $[1, i-1]$ 和 $[i+1, r]$ 中分别选出 $a$ 个和 $b$ 个。
于是这几种合并起来就等价于 $\binom{r+1}{a+b+1}$ 。
因此左右两边组合意义等价，等式成立。

为啥不重复？
我们考虑 $S$ 是升序的  $a_i$ ，即为第 $a+1$ 小，我们钦定 $i$ 的时候保证了独立性


### 10. 第二类二项式反演

$$f(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} g(i) \iff g(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} f(i)$$

代数推导：
已知：$g(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} f(i)$
则：

$$\begin{aligned}
\sum_{i=0}^n (-1)^i \binom{n}{i} g(i) &= \sum_{i=0}^n (-1)^i \binom{n}{i} \sum_{j=0}^i (-1)^j \binom{i}{j} f(j) \\
&= \sum_{i=0}^n \sum_{j=0}^i (-1)^{i+j} \binom{n}{i} \binom{i}{j} f(j)  \\
&= \sum_{i=0}^n \sum_{j=0}^i (-1)^{i+j} \binom{n}{j} \binom{n-j}{i-j} f(j) \\
&= \sum_{j=0}^n (-1)^j \binom{n}{j} f(j) \sum_{i=j}^n (-1)^i \binom{n-j}{i-j} \\
&= \sum_{j=0}^n (-1)^j \binom{n}{j} f(j) \sum_{i=0}^{n-j} (-1)^{i+j} \binom{n-j}{i} \\
&= \sum_{j=0}^n \binom{n}{j} f(j) \sum_{i=0}^{n-j} (-1)^{i} (-1)^{2j} \binom{n-j}{i} \\
&= \sum_{j=0}^n \binom{n}{j} f(j) \sum_{i=0}^{n-j} (-1)^{i} \binom{n-j}{i} \\
&= \sum_{j=0}^n \binom{n}{j} f(j) [n-j=0] \\
&= f(n)
\end{aligned}$$

积式->变换求和顺序->第一类二项式反演

然后我们还可以得到一个扩展：

$$f(n) = \sum_{i=0}^n \binom{n}{i} g(i) \iff g(n) = \sum_{i=0}^n (-1)^{n-i} \binom{n}{i} f(i)$$

证明：
令 $G(n) = (-1)^n g(n)$ ，有：
若 $f(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} G(i)$ 成立，有 $G(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} f(i)$。
即

$$G(n) = \sum_{i=0}^n (-1)^i \binom{n}{i} f(i) \\
\therefore g(n)(-1)^n = \sum_{i=0}^n (-1)^i \binom{n}{i} f(i)$$

当 $n$ 为偶数，则 $n-i$ 与 $i$ 奇偶性相同，有 $g(n) = \sum_{i=0}^n (-1)^{n-i} \binom{n}{i} f(i)$
当 $n$ 为奇数，则 $n-i$ 与 $i$ 奇偶性相反，同样有 $g(n) = \sum_{i=0}^n (-1)^{n-i} \binom{n}{i} f(i)$
由此有 $g(n) = \sum_{i=0}^n (-1)^{n-i} \binom{n}{i} f(i)$

### 11.浅对角线求和
$$
\sum_{i=0}^n\binom{n-i}{i}=F_{n+1}
$$
组合意义：爬楼梯 (Climbing Stairs)问题： 
假设你要爬一个 $n$ 级台阶的楼梯。你每次只能走 1阶 或 2阶。问有多少种不同的爬法？
角度 A：动态规划（对应右边 $F_{n+1}$）设 $f(n)$ 为爬 $n$ 级台阶的方法数。
最后一步可能是迈了 1 阶（前一步在 $n-1$），或者是迈了 2 阶（前一步在 $n-2$）。
递推公式：$f(n) = f(n-1) + f(n-2)$。初始值：$f(0)=1$ (不动也是一种), $f(1)=1$。这是标准的斐波那契数列定义。
所以总方案数对应 $F_{n+1}$。
角度 B：枚举“迈2阶”的次数（对应左边 $\sum$）我们换一种数法：按“一共迈了几次 2 阶”来分类。假设我们在整个过程中，一共迈了 $i$ 次 2阶。消耗台阶数：这 $i$ 次 2 阶共消耗了 $2i$ 级台阶。剩余台阶数：剩下的 $n - 2i$ 级台阶，必须全部由 1阶 走完（共 $n - 2i$ 次 1 阶）。
总步数：
$$\text{总步数} = (\text{2阶的次数}) + (\text{1阶的次数}) = i + (n - 2i) = n - i$$排列组合：我们要在这 $n-i$ 步中，选出哪 $i$ 步是走“2阶”的。这相当于从 $n-i$ 个位置中选 $i$ 个位置。方案数为：$\binom{n-i}{i}$。结论既然所有的方案就是枚举 $i$ 从 $0$ 到最大可能值（$\lfloor n/2 \rfloor$），把这些情况加起来，就是总的爬楼梯方案数。$$\sum_{i} \binom{n-i}{i} = \text{爬n阶楼梯的总方案数} = F_{n+1}$$

## 多重集的组合数 1

设 $S=\{n_1\cdot a_1,n_2\cdot a_2,\cdots,n_k\cdot a_k\}$ 表示由 $n_1$ 个 $a_1$，$n_2$ 个 $a_2$，…，$n_k$ 个 $a_k$ 组成的多重集。那么对于整数 $r(r<n_i,\forall i\in[1,k])$，从 $S$ 中选择 $r$ 个元素组成一个多重集的方案数就是 **多重集的组合数**。这个问题等价于 $x_1+x_2+\cdots+x_k=r$ 的非负整数解的数目，可以用插板法解决，答案为

$$
\binom{r+k-1}{k-1}
$$

## 多重集的组合数 2

考虑这个问题：设 $S=\{n_1\cdot a_1,n_2\cdot a_2,\cdots,n_k\cdot a_k,\}$ 表示由 $n_1$ 个 $a_1$，$n_2$ 个 $a_2$，…，$n_k$ 个 $a_k$ 组成的多重集。那么对于正整数 $r$，从 $S$ 中选择 $r$ 个元素组成一个多重集的方案数。

这样就限制了每种元素的取的个数。同样的，我们可以把这个问题转化为带限制的线性方程求解：

$$
\forall i\in [1,k],\ x_i\le n_i,\ \sum_{i=1}^kx_i=r
$$

于是很自然地想到了容斥原理。容斥的模型如下：

1.  全集：$\displaystyle \sum_{i=1}^kx_i=r$ 的非负整数解。
2.  属性：$x_i\le n_i$。

于是设满足属性 $i$ 的集合是 $S_i$，$\overline{S_i}$ 表示不满足属性 $i$ 的集合，即满足 $x_i\ge n_i+1$ 的集合（转化为上面插板法的问题三）。

怎么转化的？
e.g.
我们强制分配 $ n_i+1 $ 个 $ a_i $ ，剩下的 $ r-(n_i+1) $ 个 $ a_i $ 可以任意取，所以方案数为 $ \binom{r-(n_i+1)+k-1}{k-1} $

那么答案即为

$$
\left|\bigcap_{i=1}^kS_i\right|=|U|-\left|\bigcup_{i=1}^k\overline{S_i}\right|
$$

根据容斥原理，有：

$$
\begin{aligned}
\left|\bigcup_{i=1}^k\overline{S_i}\right|
=&\sum_i\left|\overline{S_i}\right|
-\sum_{i,j}\left|\overline{S_i}\cap\overline{S_j}\right|
+\sum_{i,j,k}\left|\overline{S_i}\cap\overline{S_j}\cap\overline{S_k}\right|
-\cdots\\
&+(-1)^{k-1}\left|\bigcap_{i=1}^k\overline{S_i}\right|\\
=&\sum_i\binom{k+r-n_i-2}{k-1}
-\sum_{i,j}\binom{k+r-n_i-n_j-3}{k-1}+\sum_{i,j,k}\binom{k+r-n_i-n_j-n_k-4}{k-1}
-\cdots\\
&+(-1)^{k-1}\binom{k+r-\sum_{i=1}^kn_i-k-1}{k-1}
\end{aligned}
$$

拿全集 $\displaystyle |U|=\binom{k+r-1}{k-1}$ 减去上式，得到多重集的组合数

$$
Ans=\sum_{p=0}^k(-1)^p\sum_{A}\binom{k+r-1-\sum_{A} n_{A_i}-p}{k-1}
$$

其中 $ A $ 是充当枚举子集的作用，满足 $|A|=p,\ A_i<A_{i+1}$。

